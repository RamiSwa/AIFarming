{% extends 'base.html' %}
{% block title %}Recommendations | AI Farming{% endblock %}

{% block content %}
<main class="container mt-4">



    <!-- Page Header -->
    <header class="mb-4">
        <h2 class="text-center display-5">üå± AI-Powered Crop Recommendations</h2>
        <p class="text-center text-muted">Receive personalized recommendations based on real-time soil and weather data.</p>
    </header>

    <!-- ‚úÖ Success Alert (Hidden by Default) -->
    <div id="success-alert" class="alert alert-success d-none text-center mx-auto w-50" style="position: relative; top: -10px;">
        ‚úÖ Recommendation saved successfully!
    </div>
    <!-- AI Crop Recommendation Form -->
    <section class="card shadow-sm p-4 mb-4">
        <h4 class="card-title mb-3">Get AI Crop Recommendation</h4>
        <form id="recommendation-form">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="crop" class="form-label">Select Crop</label>
                    <select id="crop" class="form-select" aria-label="Select Crop" required></select>
                </div>
                <div class="col-md-4">
                    <label for="latitude" class="form-label">Latitude</label>
                    <input type="number" id="latitude" class="form-control" step="any" placeholder="e.g. 34.0522" aria-label="Latitude">
                </div>
                <div class="col-md-4">
                    <label for="longitude" class="form-label">Longitude</label>
                    <input type="number" id="longitude" class="form-control" step="any" placeholder="e.g. -118.2437" aria-label="Longitude">
                </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-primary">
                    Get Recommendation
                    <span class="spinner-border spinner-border-sm d-none" id="loading-spinner" role="status" aria-hidden="true"></span>
                </button>
            </div>
        </form>
    </section>

    <!-- Recommendations Results -->
    <section id="recommendation-results" class="card shadow-sm p-4 mb-4 d-none">
        <h4 class="card-title mb-3">Recommendation Results</h4>
        <div class="row">
            <div class="col-md-6">
                <p><strong>üåæ Crop:</strong> <span id="crop-name"></span></p>
                <p><strong>Predicted Soil Temp:</strong> <span id="predicted-soil-temp"></span>¬∞C</p>
                <p><strong>Risk Assessment:</strong> <span class="badge" id="risk-assessment"></span></p>
                <p><strong>Predicted Yield:</strong> <span id="predicted-yield"></span></p>
                <p><strong>Expected Yield:</strong> <span id="expected-yield"></span></p>
                <p><strong>Optimal Planting Time:</strong> <span id="planting-time"></span></p>
                <p><strong>Weather Summary:</strong> <span id="weather-summary"></span></p>
                <p><strong>AI Model Version:</strong> <span class="badge bg-info" id="ai-model-version"></span></p>
            </div>
            <div class="col-md-6">
                <!-- Next Best Action -->
                <h5>üöÄ Next Best Action:</h5>
                <p id="next-best-action" class="alert alert-warning text-center fw-bold"></p>
            </div>
        </div>

        <!-- Additional Details Accordion -->
        <div class="accordion mt-4" id="recommendationAccordion">
            <!-- Yield Analysis -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="yieldAnalysisHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#yieldAnalysis" aria-expanded="false" aria-controls="yieldAnalysis">
                        üìä Yield Analysis
                    </button>
                </h2>
                <div id="yieldAnalysis" class="accordion-collapse collapse" aria-labelledby="yieldAnalysisHeading" data-bs-parent="#recommendationAccordion">
                    <div class="accordion-body">
                        <ul class="list-group">
                            <li class="list-group-item"><strong>Soil Temperature:</strong> <span id="yield-analysis-soil-temp"></span>¬∞C</li>
                            <li class="list-group-item"><strong>Yield Prediction:</strong> <span id="yield-analysis-yield-prediction"></span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- Yield Explanation -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="yieldExplanationHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#yieldExplanation" aria-expanded="false" aria-controls="yieldExplanation">
                        üìä Yield Explanation
                    </button>
                </h2>
                <div id="yieldExplanation" class="accordion-collapse collapse" aria-labelledby="yieldExplanationHeading" data-bs-parent="#recommendationAccordion">
                    <div class="accordion-body">
                        <ul id="yield-explanation" class="list-group"></ul>
                    </div>
                </div>
            </div>
            <!-- Mitigation Suggestions -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="mitigationSuggestionsHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mitigationSuggestions" aria-expanded="false" aria-controls="mitigationSuggestions">
                        üí° Mitigation Suggestions
                    </button>
                </h2>
                <div id="mitigationSuggestions" class="accordion-collapse collapse" aria-labelledby="mitigationSuggestionsHeading" data-bs-parent="#recommendationAccordion">
                    <div class="accordion-body" id="mitigation-suggestions"></div>
                </div>
            </div>
            <!-- Historical Trends -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="historicalTrendsHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#historicalTrends" aria-expanded="false" aria-controls="historicalTrends">
                        üìà Historical Trends
                    </button>
                </h2>
                <div id="historicalTrends" class="accordion-collapse collapse" aria-labelledby="historicalTrendsHeading" data-bs-parent="#recommendationAccordion">
                    <div class="accordion-body">
                        <ul id="historical-trends" class="list-group"></ul>
                    </div>
                </div>
            </div>
            <!-- Alerts -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="alertsHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#alertsCollapse" aria-expanded="false" aria-controls="alertsCollapse">
                        ‚ö† Alerts
                    </button>
                </h2>
                <div id="alertsCollapse" class="accordion-collapse collapse" aria-labelledby="alertsHeading" data-bs-parent="#recommendationAccordion">
                    <div class="accordion-body">
                        <ul id="alerts" class="list-group"></ul>
                    </div>
                </div>
            </div>
            <!-- Alternative Farming Advice -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="alternativeAdviceHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#alternativeAdvice" aria-expanded="false" aria-controls="alternativeAdvice">
                        üå± Alternative Farming Advice
                    </button>
                </h2>
                <div id="alternativeAdvice" class="accordion-collapse collapse" aria-labelledby="alternativeAdviceHeading" data-bs-parent="#recommendationAccordion">
                    <div class="accordion-body">
                        <ul id="alternative-farming-advice" class="list-group"></ul>
                    </div>
                </div>
            </div>
            <!-- Recommended Crops -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="recommendedCropsHeading">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#recommendedCrops" aria-expanded="false" aria-controls="recommendedCrops">
                        üåæ Alternative Recommended Crops
                    </button>
                </h2>
                <div id="recommendedCrops" class="accordion-collapse collapse" aria-labelledby="recommendedCropsHeading" data-bs-parent="#recommendationAccordion">
                    <div class="accordion-body" id="recommended-crops-list"></div>
                </div>
            </div>
        </div>       
    </section>
    
<!-- Saved Recommendations Table -->
<section class="card shadow-sm p-4 mb-4">
    <h4 class="card-title mb-3">üìã Saved Recommendations</h4>

    <!-- Filters -->
    <div class="row g-3 mb-3">
        <div class="col-md-4">
            <label for="filterCrop" class="form-label">Crop</label>
            <select id="filterCrop" class="form-select">
                <option value="">All Crops</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filterRisk" class="form-label">Risk Level</label>
            <select id="filterRisk" class="form-select">
                <option value="">All Levels</option>
                <option value="Low risk">üü¢ Low</option>
                <option value="Medium risk">üü° Medium</option>
                <option value="High risk">üî¥ High</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filterDate" class="form-label">Date Range</label>
            <div class="input-group">
              <input type="text" id="filterDate" class="form-control" placeholder="Select date range" readonly>
              <button id="filterBtn" class="btn btn-outline-secondary m-lg-2" type="button">Filter</button>
            </div>
          </div>
    </div>
    

    <div class="table-responsive">
        <table class="table table-striped align-middle" id="recommendationsTable">
            <thead>
                <tr>
                    <th>Crop üåæ</th>
                    <th>Predicted Yield üìä</th>
                    <th>Expected Yield üìä</th>
                    <th>Risk Level üî¥üü°üü¢</th>
                    <th>Optimal Planting Time ‚è≥</th>
                    <th>Created At üóìÔ∏è</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Pagination Controls (your existing pagination code) -->
    <div class="d-flex justify-content-center mt-3 ">
        <nav>
          <ul class="pagination"></ul>
        </nav>
      </div>
</section>

  <!-- CSV Export Accordion -->
  <section class="card shadow-sm p-4 mb-4">
    <h4 class="card-title mb-3">üìÇ Export Filtered CSV</h4>
    <div class="accordion" id="exportCSVAccordion">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#exportCSVSection">
            CSV Export Options
          </button>
        </h2>
        <div id="exportCSVSection" class="accordion-collapse collapse">
          <div class="accordion-body">
            <div class="mb-2">
              <label for="exportCrop" class="form-label">Crop:</label>
              <select id="exportCrop" class="form-select">
                <option value="">All Crops</option>
              </select>
            </div>
            <div class="mb-2">
              <label for="exportRisk" class="form-label">Risk Level:</label>
              <select id="exportRisk" class="form-select">
                <option value="">All Levels</option>
                <option value="Low risk">üü¢ Low</option>
                <option value="Medium risk">üü° Medium</option>
                <option value="High risk">üî¥ High</option>
              </select>
            </div>
            <div class="mb-2">
              <label for="exportDateRange" class="form-label">Date Range:</label>
              <input type="text" id="exportDateRange" class="form-control" placeholder="Select date range" readonly>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-outline-secondary" type="button" onclick="clearExportFilters()">‚ùå Clear</button>
              <button class="btn btn-success" type="button" onclick="exportFilteredCSV()">‚¨á Export CSV</button>
              <button class="btn btn-primary" type="button" onclick="previewExportData()">üëÄ Preview Export</button>
            </div>
            <!-- Container for export preview -->
            <div id="exportPreviewContainer" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>
  </section>


<!-- View Recommendation Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewModalLabel">Recommendation Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

</main>

<style>
    /* Custom Styles for a cleaner look */
    .list-group-item {
        padding: 10px;
        border-radius: 5px;
        background-color: #f8f9fa;
        border-left: 5px solid #28a745;
        font-size: 14px;
    }
    .alert-box {
        background-color: #ffebee;
        color: #b71c1c;
        padding: 10px;
        border-radius: 5px;
        border-left: 5px solid #d32f2f;
        font-weight: bold;
    }
    #next-best-action {
        font-size: 1.1rem;
    }
    .badge {
        padding: 8px 12px;
        font-size: 14px;
    }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const token = sessionStorage.getItem("authToken");
    const csrftoken = getCookie("csrftoken");
    const cropSelect = document.getElementById("crop");
    let currentRecommendationData = null; // Store recommendation data
    const recommendationsTable = document.querySelector("#recommendationsTable tbody");
    const pagination = document.querySelector(".pagination");
    const filterCrop = document.getElementById("filterCrop");
    const filterRisk = document.getElementById("filterRisk");
    const filterDateElem = document.getElementById("filterDate");
    const filterBtn = document.getElementById("filterBtn");
    const downloadCSV = document.getElementById("downloadCSV");
    let recommendationsData = [];


    // Also for export controls:
    const exportCrop = document.getElementById("exportCrop");
    const exportRisk = document.getElementById("exportRisk");
    const exportDateRange = document.getElementById("exportDateRange");
    const exportBtn = document.getElementById("filterBtn"); // Not used for export; we have separate buttons.

    // ‚úÖ Function to show success alert
    function showSuccessAlert() {
        const alertBox = document.getElementById("success-alert");
        if (!alertBox) {
            console.error("‚ùå Error: 'success-alert' element not found!");
            return;
        }
        alertBox.classList.remove("d-none");

        // Auto-hide after 3 seconds
        setTimeout(() => {
            alertBox.classList.add("d-none");
        }, 3000);
    }

    // Initialize flatpickr for filter date range (table)
    flatpickr("#filterDate", { mode: "range", dateFormat: "Y-m-d" });
    // Initialize flatpickr for export date range
    flatpickr("#exportDateRange", { mode: "range", dateFormat: "Y-m-d" });


    // When the filter button is clicked, or when crop or risk changes, trigger filtering:
    filterBtn.addEventListener("click", filterRecommendations);
    filterCrop.addEventListener("change", filterRecommendations);
    filterRisk.addEventListener("change", filterRecommendations);


    // Populate crop options for both the recommendation form and export controls
    function populateCropOptions(data) {
        cropSelect.innerHTML = '<option value="">Select Crop</option>';
        filterCrop.innerHTML = '<option value="">All Crops</option>';
        exportCrop.innerHTML = '<option value="">All Crops</option>';
        data.forEach(crop => {
        const option = document.createElement("option");
        option.value = crop.name;
        option.textContent = crop.name;
        cropSelect.appendChild(option);
        
        const option2 = option.cloneNode(true);
        filterCrop.appendChild(option2);
        
        const option3 = option.cloneNode(true);
        exportCrop.appendChild(option3);
        });
    }


    // Helper function to create a list-group item
    function createListItem(text, extraClasses = "") {
        const li = document.createElement("li");
        li.textContent = text;
        li.className = `list-group-item ${extraClasses}`;
        return li;
    }

    // Helper function to create a card for suggestions
    function createSuggestionCard(suggestion) {
        const card = document.createElement("div");
        card.className = "card text-success border-success mb-2";
        card.innerHTML = `<div class="card-body">‚úÖ ${suggestion}</div>`;
        return card;
    }

    // Fetch crops for dropdown
    fetch("/recommendations/api/crops/", {
        headers: { "Authorization": `Token ${token}` }
      })
      .then(response => response.json())
      .then(data => {
        populateCropOptions(data);
      });

    // Handle form submission
    document.getElementById("recommendation-form").addEventListener("submit", function (e) {
        e.preventDefault();
        document.getElementById("loading-spinner").classList.remove("d-none");

        const crop = document.getElementById("crop").value;
        const latitude = document.getElementById("latitude").value.trim();
        const longitude = document.getElementById("longitude").value.trim();

        let formData = { crop };

        if (latitude !== "" && longitude !== "") {
            formData.latitude = parseFloat(latitude);
            formData.longitude = parseFloat(longitude);
        }

        fetch("/recommendations/api/predict/", {
            method: "POST",
            headers: {
                "Authorization": `Token ${token}`,
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            console.log("API Response:", data);

            if (data.status === "error") {
                alert(`‚ùå API Error: ${data.message}`);
                return;
            }

            currentRecommendationData = data.recommendation; // Store data for saving

            // ‚úÖ Display success alert
            showSuccessAlert();


            // Display prediction results
            document.getElementById("crop-name").textContent =
                data.recommendation.crop || "Not Available";
            document.getElementById("predicted-soil-temp").textContent = parseFloat(data.predicted_soil_temp).toFixed(2);
            const riskEl = document.getElementById("risk-assessment");
            riskEl.textContent = data.risk_assessment;
            riskEl.className = data.risk_assessment === "Low risk" ? "badge bg-success" :
                                data.risk_assessment === "Medium risk" ? "badge bg-warning" :
                                "badge bg-danger"; // High risk
            
            document.getElementById("predicted-yield").textContent = parseFloat(data.predicted_yield).toFixed(2);
            document.getElementById("expected-yield").textContent = parseFloat(data.recommendation.expected_yield).toFixed(2);
            document.getElementById("planting-time").textContent = data.recommendation.optimal_planting_time || "Not Available";
            document.getElementById("weather-summary").textContent = data.weather_summary || "No weather summary available.";
            const modelVersions = data.recommendation.ai_model_version;
            let modelObj = null;
            
            // Check if the value exists
            if (modelVersions) {
              // If it's a string, try to parse it as JSON
              if (typeof modelVersions === 'string') {
                try {
                  modelObj = JSON.parse(modelVersions);
                } catch (e) {
                  console.error("Failed to parse ai_model_version:", e);
                  modelObj = null;
                }
              } else if (typeof modelVersions === 'object') {
                modelObj = modelVersions;
              }
            }
            
            if (modelObj) {
              const formattedVersions = Object.entries(modelObj)
                .map(([key, value]) => {
                  // Convert snake_case key to Title Case
                  const titleCaseKey = key
                    .split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                  return `${titleCaseKey}: ${value}`;
                })
                .join(' | ');
              document.getElementById("ai-model-version").textContent = formattedVersions;
            } else {
              document.getElementById("ai-model-version").textContent = "Unknown";
            }
            


            // Yield Analysis
            document.getElementById("yield-analysis-soil-temp").textContent = parseFloat(data.predicted_soil_temp).toFixed(2);
            document.getElementById("yield-analysis-yield-prediction").textContent = parseFloat(data.predicted_yield).toFixed(2);

            // Next Best Action with enhanced styling
            const nextBestActionElement = document.getElementById("next-best-action");
            nextBestActionElement.textContent = data.next_best_action || "No suggested action.";
            nextBestActionElement.style.color = "#dc3545";
            nextBestActionElement.style.fontWeight = "bold";


            // Recommended Crops Badges
            const cropList = document.getElementById("recommended-crops-list");
            cropList.innerHTML = "";
            if (data.recommendation.recommended_crops && data.recommendation.recommended_crops.crops.length > 0) {
                data.recommendation.recommended_crops.crops.forEach(crop => {
                    const badge = document.createElement("span");
                    badge.className = "badge bg-primary m-1";
                    badge.textContent = crop;
                    cropList.appendChild(badge);
                });
            } else {
                cropList.innerHTML = "<span class='text-muted'>No alternative crops found.</span>";
            }

            // Yield Explanation
            const yieldExplanationList = document.getElementById("yield-explanation");
            yieldExplanationList.innerHTML = "";
            data.yield_explanation.forEach(explanation => {
                yieldExplanationList.appendChild(createListItem(explanation));
            });

            // Mitigation Suggestions
            const mitigationList = document.getElementById("mitigation-suggestions");
            mitigationList.innerHTML = "";
            data.mitigation_suggestions.forEach(suggestion => {
                mitigationList.appendChild(createSuggestionCard(suggestion));
            });

            // Historical Trends
            const historicalList = document.getElementById("historical-trends");
            historicalList.innerHTML = "";
            data.historical_trends.forEach(trend => {
                historicalList.appendChild(createListItem(`üìà ${trend}`));
            });

            // Alerts
            const alertsList = document.getElementById("alerts");
            alertsList.innerHTML = "";
            data.alerts.forEach(alert => {
                const li = createListItem(`${alert}`, "alert alert-danger fw-bold");
                li.innerHTML = `<span class="badge bg-danger">‚ö†</span> ${alert}`;
                alertsList.appendChild(li);
            });

            // Alternative Farming Advice
            const farmingAdviceList = document.getElementById("alternative-farming-advice");
            farmingAdviceList.innerHTML = "";
            if (data.alternative_farming_advice && data.alternative_farming_advice.length > 0) {
                data.alternative_farming_advice.forEach(advice => {
                    farmingAdviceList.appendChild(createListItem(advice));
                });
            } else {
                farmingAdviceList.innerHTML = "<li class='text-muted list-group-item'>No alternative farming advice available.</li>";
            }


            document.getElementById("recommendation-results").classList.remove("d-none");
            document.getElementById("loading-spinner").classList.add("d-none");
        })
        .catch(error => {
            console.error("‚õî Fetch Failed:", error);
            alert("An error occurred. Please try again.");
            document.getElementById("loading-spinner").classList.add("d-none");
        });
    });

    // GET Recommendations table, Filter, CSV
    // Attach function to the global window object

    // Function to fetch recommendations with an optional date filter:
    window.fetchRecommendations = function (page = 1) {
        let url = `/recommendations/api/recommendations/?page=${page}`;
        
        const cropValue = filterCrop.value;
        if (cropValue) {
            url += `&crop=${encodeURIComponent(cropValue)}`;
        }
        const riskValue = filterRisk.value;
        if (riskValue) {
            url += `&risk=${encodeURIComponent(riskValue)}`;
        }
        const dateRange = filterDateElem.value; // Now defined
        if (dateRange) {
            const dates = dateRange.split(" to ");
            if (dates.length === 2) {
                const start_date = dates[0];
                const end_date = dates[1];
                url += `&start_date=${encodeURIComponent(start_date)}&end_date=${encodeURIComponent(end_date)}`;
            }
        }

        
        fetch(url, { headers: { "Authorization": `Token ${token}` } })
            .then(response => response.json())
            .then(data => {
                console.log("API Response:", data);
                if (data && data.results) {
                    recommendationsData = data.results;
                    populateTable(recommendationsData);
                    setupPagination(data.count, page, data.next, data.previous);
                } else {
                    console.error("API did not return results:", data);
                    recommendationsTable.innerHTML = "<tr><td colspan='7' class='text-center text-danger'>No data available</td></tr>";
                }
            })
            .catch(error => {
                console.error("API Fetch Error:", error);
                recommendationsTable.innerHTML = "<tr><td colspan='7' class='text-center text-danger'>Error loading data</td></tr>";
            });
    };


    // A helper function to trigger filtering:
    function filterRecommendations() {
        // Optionally, you can reset to page 1 when filtering.
        fetchRecommendations(1);
    }

    // Populate table
    function populateTable(data) {
        recommendationsTable.innerHTML = "";
        data.forEach(rec => {
            const predictedYield = (rec.predicted_yield !== undefined && rec.predicted_yield !== null && !isNaN(rec.predicted_yield)) 
                ? parseFloat(rec.predicted_yield).toFixed(2) 
                : "N/A";
    
            const expectedYield = (rec.expected_yield !== undefined && rec.expected_yield !== null && !isNaN(rec.expected_yield)) 
                ? parseFloat(rec.expected_yield).toFixed(2) 
                : "N/A";
    
            const cropName = rec.crop && typeof rec.crop === 'object' && rec.crop.name ? rec.crop.name : "Unknown";
    
            const row = `<tr>
                <td>${cropName}</td>
                <td>${predictedYield}</td>
                <td>${expectedYield}</td>
                <td><span class="badge bg-${rec.risk_assessment === 'Low risk' ? 'success' : rec.risk_assessment === 'Medium risk' ? 'warning' : 'danger'}">
                    ${rec.risk_assessment || "N/A"}</span></td>
                <td>${rec.optimal_planting_time || "Unknown"}</td>
                <td>${rec.created_at ? new Date(rec.created_at).toLocaleDateString() : "N/A"}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewRecommendation(${rec.id})">üëÅ View</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecommendation(${rec.id})">üóë Delete</button>
                </td>
            </tr>`;            
            recommendationsTable.innerHTML += row;
        });
    }
    

    // Setup pagination controls
    function setupPagination(total, currentPage, nextUrl, prevUrl) {
        const totalPages = Math.ceil(total / 10); // using page_size=10 from your pagination class
        // Build the HTML for pagination controls:
        const paginationHTML = `
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
              <li class="page-item ${prevUrl ? '' : 'disabled'}" id="prevPageItem">
                <button class="page-link" id="prevBtn" ${prevUrl ? `onclick="fetchRecommendations(${currentPage - 1})"` : ''}>Previous</button>
              </li>
              <li class="page-item disabled">
                <span class="page-link" id="pageInfo">Page ${currentPage} of ${totalPages}</span>
              </li>
              <li class="page-item ${nextUrl ? '' : 'disabled'}" id="nextPageItem">
                <button class="page-link" id="nextBtn" ${nextUrl ? `onclick="fetchRecommendations(${currentPage + 1})"` : ''}>Next</button>
              </li>
            </ul>
          </nav>
        `;
        // Insert this HTML into the pagination container (make sure it exists in your HTML)
        pagination.innerHTML = paginationHTML;
    }
    
    
    // Modal
    window.viewRecommendation = function (id) {
        let rec = recommendationsData.find(r => r.id === id);
        if (!rec) {
            console.error("Recommendation not found for ID:", id);
            return;
        }
        
        // Format basic values
        let cropName = (rec.crop && typeof rec.crop === "object" && rec.crop.name)
            ? rec.crop.name
            : (typeof rec.crop === "string" ? rec.crop : "Unknown");
        let predictedYield = (rec.predicted_yield && typeof rec.predicted_yield === "number")
            ? rec.predicted_yield.toFixed(2)
            : "N/A";
        let expectedYield = (rec.expected_yield && typeof rec.expected_yield === "number")
            ? rec.expected_yield.toFixed(2)
            : "N/A";
        let predictedSoilTemp = rec.predicted_soil_temp ? parseFloat(rec.predicted_soil_temp).toFixed(2) : "N/A";
        let plantingTime = rec.optimal_planting_time || "Not Available";
        let weatherSummary = rec.weather_summary || "No weather summary available.";
        let riskAssessment = rec.risk_assessment || "Unknown";
        let nextBestAction = rec.next_best_action || "No suggested action.";
        let confidenceScore = rec.confidence_score || "N/A";
        let createdAt = rec.created_at ? new Date(rec.created_at).toLocaleDateString() : "N/A";
        
        // Format the AI Model Version (same as in Recommendation Results)
        const modelVersions = rec.ai_model_version;
        let modelObj = null;
        if (modelVersions) {
            if (typeof modelVersions === 'string') {
                try {
                    modelObj = JSON.parse(modelVersions);
                } catch (e) {
                    console.error("Failed to parse ai_model_version:", e);
                }
            } else if (typeof modelVersions === 'object') {
                modelObj = modelVersions;
            }
        }
        let formattedModelVersion = "Unknown";
        if (modelObj) {
            formattedModelVersion = Object.entries(modelObj)
                .map(([key, value]) => {
                    // Convert snake_case key to Title Case
                    const titleCaseKey = key
                        .split('_')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                    return `${titleCaseKey}: ${value}`;
                })
                .join(' | ');
        }
        
        // Build modal content using the same design as Recommendation Results
        let modalBody = document.getElementById("modalBody");
        modalBody.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>üåæ Crop:</strong> ${cropName}</p>
              <p><strong>Predicted Soil Temp:</strong> ${predictedSoilTemp}¬∞C</p>
              <p><strong>Risk Assessment:</strong> ${riskAssessment}</p>
              <p><strong>Predicted Yield:</strong> ${predictedYield}</p>
              <p><strong>Expected Yield:</strong> ${expectedYield}</p>
              <p><strong>Optimal Planting Time:</strong> ${plantingTime}</p>
              <p><strong>Weather Summary:</strong> ${weatherSummary}</p>
              <p><strong>AI Model Version:</strong> ${formattedModelVersion}</p>
            </div>
            <div class="col-md-6">
              <h5>üöÄ Next Best Action:</h5>
              <p class="alert alert-warning text-center fw-bold">${nextBestAction}</p>
              <p><strong>Created At:</strong> ${createdAt}</p>
            </div>
          </div>
          <hr/>
          <div class="accordion" id="modalAccordion">
            <!-- Yield Analysis -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="modalYieldAnalysisHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalYieldAnalysis" aria-expanded="false" aria-controls="modalYieldAnalysis">
                  üìä Yield Analysis
                </button>
              </h2>
              <div id="modalYieldAnalysis" class="accordion-collapse collapse" aria-labelledby="modalYieldAnalysisHeading" data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                  <ul class="list-group">
                    <li class="list-group-item"><strong>Soil Temperature:</strong> ${predictedSoilTemp}¬∞C</li>
                    <li class="list-group-item"><strong>Yield Prediction:</strong> ${predictedYield}</li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- Yield Explanation -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="modalYieldExplanationHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalYieldExplanation" aria-expanded="false" aria-controls="modalYieldExplanation">
                  üìä Yield Explanation
                </button>
              </h2>
              <div id="modalYieldExplanation" class="accordion-collapse collapse" aria-labelledby="modalYieldExplanationHeading" data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                  <ul class="list-group">
                    ${rec.yield_explanation 
                      ? rec.yield_explanation.map(ex => `<li class="list-group-item">${ex}</li>`).join("") 
                      : "<li class='list-group-item'>No yield explanation available.</li>"}
                  </ul>
                </div>
              </div>
            </div>
            <!-- Mitigation Suggestions -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="modalMitigationHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalMitigation" aria-expanded="false" aria-controls="modalMitigation">
                  üí° Mitigation Suggestions
                </button>
              </h2>
              <div id="modalMitigation" class="accordion-collapse collapse" aria-labelledby="modalMitigationHeading" data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                  ${rec.mitigation_suggestions && rec.mitigation_suggestions.length > 0 
                    ? rec.mitigation_suggestions.map(s => `<div class="card mb-2"><div class="card-body">‚úÖ ${s}</div></div>`).join("")
                    : "<p>No mitigation suggestions available.</p>"}
                </div>
              </div>
            </div>
            <!-- Historical Trends -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="modalHistoricalTrendsHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalHistoricalTrends" aria-expanded="false" aria-controls="modalHistoricalTrends">
                  üìà Historical Trends
                </button>
              </h2>
              <div id="modalHistoricalTrends" class="accordion-collapse collapse" aria-labelledby="modalHistoricalTrendsHeading" data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                  <ul class="list-group">
                    ${rec.historical_trends 
                      ? rec.historical_trends.map(tr => `<li class="list-group-item">üìà ${tr}</li>`).join("") 
                      : "<li class='list-group-item'>No historical trends available.</li>"}
                  </ul>
                </div>
              </div>
            </div>
            <!-- Alerts -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="modalAlertsHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalAlerts" aria-expanded="false" aria-controls="modalAlerts">
                  ‚ö† Alerts
                </button>
              </h2>
              <div id="modalAlerts" class="accordion-collapse collapse" aria-labelledby="modalAlertsHeading" data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                  <ul class="list-group">
                    ${rec.alerts 
                      ? rec.alerts.map(a => `<li class="list-group-item"><span class="badge bg-danger">‚ö†</span> ${a}</li>`).join("") 
                      : "<li class='list-group-item'>No alerts available.</li>"}
                  </ul>
                </div>
              </div>
            </div>
            <!-- Alternative Farming Advice -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="modalAlternativeAdviceHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalAlternativeAdvice" aria-expanded="false" aria-controls="modalAlternativeAdvice">
                  üå± Alternative Farming Advice
                </button>
              </h2>
              <div id="modalAlternativeAdvice" class="accordion-collapse collapse" aria-labelledby="modalAlternativeAdviceHeading" data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                  <ul class="list-group">
                    ${rec.alternative_farming_advice 
                      ? rec.alternative_farming_advice.map(advice => `<li class="list-group-item">${advice}</li>`).join("") 
                      : "<li class='list-group-item'>No alternative advice available.</li>"}
                  </ul>
                </div>
              </div>
            </div>
            <!-- Alternative Recommended Crops -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="modalRecommendedCropsHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#modalRecommendedCrops" aria-expanded="false" aria-controls="modalRecommendedCrops">
                  üåæ Alternative Recommended Crops
                </button>
              </h2>
              <div id="modalRecommendedCrops" class="accordion-collapse collapse" aria-labelledby="modalRecommendedCropsHeading" data-bs-parent="#modalAccordion">
                <div class="accordion-body">
                  ${rec.recommended_crops && rec.recommended_crops.crops && rec.recommended_crops.crops.length > 0 
                    ? rec.recommended_crops.crops.map(c => `<span class="badge bg-primary m-1">${c}</span>`).join("")
                    : "<p>No alternative crops found.</p>"}
                </div>
              </div>
            </div>
          </div>
        `;
        
        let modalElement = document.getElementById("viewModal");
        // Remove any inert or aria-hidden settings before showing the modal
        modalElement.removeAttribute("inert");
        modalElement.setAttribute("aria-hidden", "false");
        
        // Initialize and show the modal
        let modal = new bootstrap.Modal(modalElement);
        modalElement.addEventListener("shown.bs.modal", function () {
            document.getElementById("viewModalLabel").focus();
        }, { once: true });
        modalElement.addEventListener("hide.bs.modal", function () {
            if (modalElement.contains(document.activeElement)) {
                document.activeElement.blur();
            }
            const triggerButton = document.querySelector('[data-bs-target="#viewModal"]');
            if (triggerButton) {
                triggerButton.focus();
            } else {
                document.body.focus();
            }
        }, { once: true });
        modal.show();
    };
    
            
    // Delete recommendation
    window.deleteRecommendation = function (id) {
        Swal.fire({
            title: "Are you sure?",
            text: "This will permanently delete the recommendation!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete it!"
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/recommendations/api/recommendations/${id}/`, {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Token ${token}`,
                        "X-CSRFToken": csrftoken
                    }
                }).then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to delete: ${response.status}`);
                    }
                    return response.json();
                }).then(() => {
                    fetchRecommendations();
                    Swal.fire("Deleted!", "Recommendation has been removed.", "success");
                }).catch(error => {
                    console.error("Delete Error:", error);
                    Swal.fire("Error", "Failed to delete recommendation.", "error");
                });
            }
        });
    };
        




  // --- Export Functions ---

  // Build a query string from export controls:
  function buildExportQuery() {
    let params = [];
    const cropVal = exportCrop.value;
    const riskVal = exportRisk.value;
    const dateRange = exportDateRange.value;
    if (cropVal) params.push("crop=" + encodeURIComponent(cropVal));
    if (riskVal) params.push("risk=" + encodeURIComponent(riskVal));
    if (dateRange) {
      const dates = dateRange.split(" to ");
      if (dates.length === 2) {
        params.push("start_date=" + encodeURIComponent(dates[0]));
        params.push("end_date=" + encodeURIComponent(dates[1]));
      }
    }
    return params.join("&");
  }

  // Clear export filters
  window.clearExportFilters = function() {
    exportCrop.value = "";
    exportRisk.value = "";
    exportDateRange.value = "";
  };


  // Export the CSV (full export)
  window.exportFilteredCSV = function() {
    const queryString = buildExportQuery();
    // Build the export URL
    const url = "/recommendations/api/recommendations/export/?" + queryString;
    console.log("Exporting CSV with URL:", url);
    
    // Use fetch to get the CSV as a blob and trigger download
    fetch(url, {
      method: "GET",
      headers: { "Authorization": `Token ${token}` }
    })
    .then(response => {
      if (!response.ok) throw new Error("Export failed");
      return response.blob();
    })
    .then(blob => {
      const csvURL = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = csvURL;
      a.download = "recommendations_export.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(csvURL);
    })
    .catch(error => {
      console.error("‚ùå Error exporting CSV:", error);
      alert("‚ùå Failed to export CSV. Please try again.");
    });
  };

  // Preview export data (fetch preview endpoint and show results)
  window.previewExportData = function() {
    const queryString = buildExportQuery();
    const url = "/recommendations/api/recommendations/export/preview/?" + queryString;
    console.log("Previewing export data with URL:", url);
    fetch(url, {
      method: "GET",
      headers: { "Authorization": `Token ${token}` }
    })
    .then(response => response.json())
    .then(data => {
      let previewHTML = "";
      if (data.length === 0) {
        previewHTML = "<p>No data found for the selected filters.</p>";
      } else {
        previewHTML = `<table class="table table-sm table-striped">
          <thead>
            <tr>
              <th>Crop</th>
              <th>Predicted Yield</th>
              <th>Risk</th>
              <th>Created At</th>
            </tr>
          </thead>
          <tbody>`;
        data.forEach(item => {
          previewHTML += `<tr>
            <td>${item.crop || "N/A"}</td>
            <td>${item.predicted_yield || "N/A"}</td>
            <td>${item.risk_assessment || "N/A"}</td>
            <td>${new Date(item.created_at).toLocaleDateString()}</td>
          </tr>`;
        });
        previewHTML += `</tbody></table>`;
      }
      document.getElementById("exportPreviewContainer").innerHTML = previewHTML;
    })
    .catch(error => {
      console.error("‚ùå Error previewing export data:", error);
      alert("‚ùå Failed to preview export data. Please try again.");
    });
  };

  // Fetch recommendations initially
  fetchRecommendations();
});
// Function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}
